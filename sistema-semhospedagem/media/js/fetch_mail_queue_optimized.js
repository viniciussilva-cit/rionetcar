if(typeof CPANEL=="undefined"||!CPANEL){var CPANEL={}}(function(){var k=window.LOCALE||new CPANEL.Locale();var h=function(m){return new Date(1000*m)};var l=function(o,n,m,p){o.innerHTML=p.map(String.prototype.html_encode.call,String.prototype.html_encode).join(" , <br /> ")};var b;var e;var d=function(q,o,r,s){var p=o.getData();if(p.frozen){var m=get_start_end_times();var n={unixstarttime:m[0]&&(m[0].getTime()/1000)};YAHOO.lang.augmentObject(n,p);if(!e){e=DOM.get("frozen_row_template").text}q.innerHTML=YAHOO.lang.substitute(e,n)}else{if(!b){b=DOM.get("queued_row_template").text}q.innerHTML=YAHOO.lang.substitute(b,p)}};var j=function(o,q,n,p){var m=new Date(p);if(/invalid date/i.test(m)){o.innerHTML=k.maketext("Invalid date")}else{o.innerHTML=m.toCpLocaleString()}};var f=function(n,m,p,q){var o=String(q).trim();CPANEL.util.set_text_content(n,o||"["+k.maketext("System")+"]")};var a=function(m,p,n,o){CPANEL.util.set_text_content(m,o?k.maketext("Frozen"):k.maketext("Queued"))};var g=function(m,p,n,o){m.innerHTML=k.format_bytes(o)};var c=[{key:"check",label:"",width:"30",formatter:YAHOO.widget.DataTable.formatCheckbox},{key:"time",label:k.maketext("Time Received"),sortable:true,formatter:j},{key:"sender",label:k.maketext("Sender"),sortable:true,formatter:f},{key:"msgid",label:k.maketext("Message ID"),sortable:true},{key:"recipients",formatter:l,label:k.maketext("Recipient(s)")},{key:"size",formatter:g,sortable:true,label:k.maketext("Size")},{key:"frozen",label:k.maketext("Status"),sortable:true,formatter:a},{key:"actions",label:k.maketext("Actions"),formatter:d}];CPANEL.MailQueue=function(n){for(var m in n){if(typeof this[m]!="undefined"){this[m]=n[m]}}init_start_end_times(this.starttime)};CPANEL.MailQueue.prototype={unixstarttime:null,unixendtime:null,starttime:"yesterday",statsfail:function(p){for(var m=0;m<p.argument.statlist.length;m++){var n=p.argument.statlist[m];document.getElementById("deliverystats_"+n).innerHTML=k.maketext("The fetch returned no data.")}},loadUnixTimes:function(){var m=get_start_end_times();this.unixstarttime=m[0]&&(m[0].getTime()/1000);this.unixendtime=m[1]&&(m[1].getTime()/1000)},buildDeliveryReport:function(){var n=this;this.loadUnixTimes();var p=new CPANEL.datasource.CPANEL_XHRDataSource({func:"fetch_mail_queue",fields:[{key:"frozen",parser:"number"},{key:"time",parser:h},"sender","msgid",{key:"size",parser:"number"},"recipients"]});var o={initialLoad:false,generateRequest:function(t,s){var r=CPANEL.datatable.get_api_data(t);if(r.sort){if(/^!?(?:size|time)$/.test(r.sort[0])){r.sort[0]=[r.sort[0],"numeric"]}}if(n.unixstarttime){r.filter.push(["time","gt",n.unixstarttime-1])}if(n.unixendtime){r.filter.push(["time","lt",n.unixendtime+1])}var q=CPANEL.dom.get_data_from_form("search-fields");if(q.freeform&&q.mainkey&&q.searchmatch){r.filter.push([q.mainkey,q.searchmatch,q.freeform])}var u=DOM.get("quicksearch").value.trim();if(u){r.filter.push(["*","contains",u])}return{api_data:r}},dynamicData:true,sortedBy:CPANEL.nvdata.initial&&CPANEL.nvdata.initial.table_sort||{key:"time",dir:YAHOO.widget.DataTable.CLASS_DESC},paginator:THE_PAGINATOR};var m=new YAHOO.widget.DataTable("mailqueuetbl",c,p,o);m.subscribe("checkboxClickEvent",function(s){var r=s.target;var q=this.getRecord(r);q.setData("check",r.checked)});m.handleDataReturnPayload=function(r,q,s){var t=parseInt(q.meta.total_records);s.totalRecords=t;return s};return{ds:p,dt:m}},updatedata:function(){if(!this.deliveryreport){this.deliveryreport=this.buildDeliveryReport()}var m={success:this.deliveryreport.dt.onDataReturnReplaceRows,failure:window.handle_ajax_error,scope:this.deliveryreport.dt,argument:this.deliveryreport.dt.getState()};this.deliveryreport.dt._oRecordSet.reset();this.deliveryreport.dt.render();this.loadUnixTimes();var n=this.deliveryreport.dt.get("generateRequest")(this.deliveryreport.dt.getState(),this.deliveryreport.dt);this.deliveryreport.ds.sendRequest(n,m)},deliverSelected:function(){this.multiAction("../scripts11/deliver_messages_mail_queue",1)},deleteSelected:function(){this.multiAction("../scripts11/remove_messages_mail_queue",1)},deleteAll:function(){if(confirm(k.maketext("Are you sure you wish to purge the entire mail queue?"))){this.multiAction("../scripts11/purge_mail_queue",0)}},deliverAll:function(){if(confirm(k.maketext("Are you sure you wish to attempt to deliver the entire mail queue?"))){this.multiAction("../scripts11/deliver_mail_queue",0)}},multiAction:function(p,n){var m=this.deliveryreport.dt.getRecordSet().getRecords();var o=[];if(n){for(i=0;i<m.length;i++){if(!m[i]){continue}var q=m[i].getData();if(q.check){o.push(q.msgid)}}document.getElementById("msgids").value=o.join(",");if(o.length==0){alert(k.maketext("You must first select at least one message in the queue."));return false}}else{document.getElementById("msgids").value=o.join(",")}document.getElementById("multiactionform").action=p;document.getElementById("multiactionform").submit()},selectAll:function(n){var m=this.deliveryreport.dt.getRecordSet().getRecords();for(i=0;i<m.length;i++){this.deliveryreport.dt.getRecordSet().updateKey(m[i],"check",(n?"":"true"))}this.deliveryreport.dt.render()},unselectAll:function(){this.selectAll(1)}}})();